# Story 1.5: Implement Full Negotiation Agent

## Status
Draft

## Story
**As a** developer,
**I want** to fully implement the LangGraph agent flow using BAML,
**so that** the chatbot can handle all negotiation cases and generate the final URL.

## Acceptance Criteria
1. All nodes and conditional edges in the LangGraph diagram are fully implemented.
2. BAML functions are created for all required AI interactions.
3. The agent correctly handles the Payer, Negotiator, Stonewaller, and "No Debt" Claim case studies.
4. The agent successfully generates the correctly formatted collectwise.com/payments URL upon reaching an agreement.

## Tasks / Subtasks
- [ ] Flesh out node logic in `graph.ts` for each negotiation pathway (AC: 1,3)
  - [ ] Implement tiered offer strategy with rejection counting for Negotiator path (AC: 1,3)
  - [ ] Implement Stonewaller fallback after 3 failed offers (AC: 1,3)
  - [ ] Handle No Debt branch with reference and contact info messaging (AC: 1,3)
- [ ] Expand BAML definitions to cover offer generation, link formatting, and fallback messaging (AC: 2)
  - [ ] Validate schema compatibility between BAML outputs and LangGraph state inputs (AC: 2)
- [ ] Generate final payment link with `{termLength,totalDebtAmount,termPaymentAmount}` query params (AC: 4)
  - [ ] Guard against invalid math (division by zero, negative amounts) (AC: 4)
- [ ] Integrate agent outputs with frontend rendering and persistence (AC: 3,4)
  - [ ] Ensure chat history reflects all system and user messages in sequence (AC: 3)

## Dev Notes
- Mirror negotiation personas defined in `docs/PRD.md` LangGraph Agent Flow; ensure prompts instruct the LLM to stay within realistic payment ranges.
- Persist intermediate state (current offer tier, rejection count) within LangGraph state object to prevent stateless regressions.
- Reuse helper utilities from Story 1.3 for URL formatting and error handling; centralize mathematics for payment plans.
- Update documentation (`README.md` or `docs/`) with examples of conversation transcripts for each persona to support QA.

### Testing
- Extend Jest table-driven tests in `backend/tests/agent.test.ts` to cover payer, negotiator multi-step, stonewaller escalation, and no-debt flows.
- Mock BAML responses to simulate edge cases (e.g., unrealistic user offers) and confirm correct transitions.
- Perform manual end-to-end session for each persona, verifying final payment URL format and history persistence.

## Change Log
| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-25 | 0.1     | Initial draft of story 1.5. | Codex  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

