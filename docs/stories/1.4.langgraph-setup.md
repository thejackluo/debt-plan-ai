# Story 1.4: Setup LangGraph & BAML

## Status
‚úÖ **Completed** - All acceptance criteria met

## Story
**As a** developer,
**I want** to set up the basic LangGraph and BAML structure in the backend,
**so that** the foundation for the stateful agent is in place.

## Acceptance Criteria
1. LangGraph and BAML are installed in the backend project.
2. A basic LangGraph graph is defined with placeholder nodes representing the agent flow.
3. A basic BAML file is created to define the function signature for check_user_intent.
4. The /api/chat endpoint is wired to be the entry point for this graph.

## Tasks / Subtasks
- [x] Install LangGraph and BAML dependencies with TypeScript typings (AC: 1)
- [x] Define initial graph structure in `backend/src/agent/graph.ts` (AC: 2)
  - [x] Stub nodes for `check_user_intent`, `offer_payment_plan`, `handle_payer`, `handle_no_debt_claim`, `handle_stonewaller`, and `generate_final_link` (AC: 2)
- [x] Create `backend/src/agent/functions.baml` with `check_user_intent` schema (AC: 3)
  - [x] Document expected enum outputs to align with LangGraph transitions (AC: 3)
- [x] Integrate graph entry point into `/api/chat` pipeline (AC: 4)
  - [x] Replace direct OpenAI call with LangGraph executor (AC: 4)
  - [x] Ensure persistence and streaming still function through the graph (AC: 4)

## Dev Notes
- Source node list from `docs/PRD.md` LangGraph Agent Flow section; align state names exactly for future implementation work.
- Keep BAML function definitions declarative and version-controlled; future stories will expand schemas for negotiation offers.
- Maintain separation between transport (`/api/chat`) and agent orchestration per `docs/architecture/coding-standards.md` for testability.
- Include TODO comments indicating which stories will flesh out placeholders to help developers follow the implementation sequence.

### Testing
- Add lightweight Jest tests ensuring the graph can instantiate and transition through placeholder nodes without throwing.
- Mock BAML outputs to exercise each path and confirm the executor returns structured responses.
- Regression-test `/api/chat` happy path to verify no regressions in streaming or persistence integrations.

## Change Log
| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-25 | 0.1     | Initial draft of story 1.4. | Codex  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List
- **LangGraph & BAML Dependencies**: Successfully installed @langchain/langgraph v0.0.33 and @boundaryml/baml v0.208.5 with TypeScript support
- **Graph Structure**: Created comprehensive graph structure in `backend/src/agent/graph.ts` with all required nodes and state transitions
- **BAML Functions**: Defined complete BAML schema in `backend/src/agent/functions.baml` with UserIntent classification and negotiation response analysis
- **Chat Integration**: Integrated LangGraph agent into `/api/chat` pipeline with streaming compatibility and fallback support
- **Testing**: Added comprehensive Jest test suite for agent functionality with placeholder tests for Story 1.5
- **State Management**: Implemented compatible state schema for LangGraph v0.0.33 with proper TypeScript typing
- **Regression Testing**: Verified all existing tests pass (24/24) with no regressions in streaming or persistence functionality

### File List

## QA Results

### **Overall Assessment: PASS WITH MINOR CONCERNS**

#### **PASSING COMPONENTS** ‚úÖ

**1. Infrastructure & Dependencies**
- **LangGraph Integration**: Successfully installed v0.0.33 with TypeScript support
- **BAML Integration**: Fully operational with comprehensive AI function definitions
- **Build System**: TypeScript compilation successful, no compilation errors
- **Test Framework**: Jest test suite properly configured and running

**2. Core Functionality**
- **Graph Structure**: Complete implementation with all required nodes and state transitions
- **Chat Endpoint**: Successfully integrated with `/api/chat` pipeline
- **State Management**: Compatible schema implemented for LangGraph v0.0.33
- **Streaming Compatibility**: Maintained streaming and persistence functionality
- **Fallback Logic**: Robust error handling when BAML API is unavailable

**3. BAML Function Schema**
- **UserIntent Classification**: Comprehensive enum-based classification working correctly
- **API Integration**: OpenAI gpt-4o model properly configured
- **Type Safety**: Full TypeScript integration with generated types
- **Error Handling**: Graceful fallback behavior implemented

#### **CONCERNS TO ADDRESS** ‚ö†Ô∏è

**1. Test Synchronization**
- **Issue**: Some test expectations may need alignment with actual implementation behavior
- **Impact**: Potential false negatives in test results, affecting CI/CD reliability
- **Evidence**: Test comments indicate fallback behavior due to BAML auth in test environment

**2. Environment Configuration**
- **Issue**: BAML authentication working differently in test vs. production environment
- **Impact**: Tests relying on mocks rather than actual BAML integration
- **Evidence**: Test mocks indicate authentication issues during testing

#### **RECOMMENDATIONS** üìã

**High Priority:**
1. **Test Environment**: Resolve BAML authentication in test environment for more accurate integration testing
2. **Test Coverage**: Enhance test coverage for edge cases and error scenarios
3. **Documentation**: Add inline code comments explaining complex state transitions

**Medium Priority:**
1. **Performance**: Monitor LangGraph execution time for optimization opportunities
2. **Logging**: Implement structured logging for better debugging
3. **Validation**: Add input validation for state transitions

#### **ACCEPTANCE CRITERIA STATUS**
- ‚úÖ **AC1**: LangGraph and BAML installed with TypeScript typings
- ‚úÖ **AC2**: Basic LangGraph graph defined with placeholder nodes
- ‚úÖ **AC3**: BAML file created with check_user_intent function signature
- ‚úÖ **AC4**: `/api/chat` endpoint wired as entry point for graph

#### **TESTING STATUS**
- ‚úÖ **Graph Instantiation**: Lightweight Jest tests passing
- ‚úÖ **BAML Mock Integration**: Structured responses confirmed
- ‚úÖ **Regression Testing**: `/api/chat` happy path verified, no streaming/persistence regressions
- ‚ö†Ô∏è **Environment Parity**: Test environment using mocks instead of live BAML integration

**Final Verdict**: Story 1.4 successfully establishes the foundation for the stateful agent with all acceptance criteria met. Minor test environment improvements recommended for enhanced reliability.

