# Story 1.4: Setup LangGraph & BAML

## Status
âœ… **Completed** - All acceptance criteria met

## Story
**As a** developer,
**I want** to set up the basic LangGraph and BAML structure in the backend,
**so that** the foundation for the stateful agent is in place.

## Acceptance Criteria
1. LangGraph and BAML are installed in the backend project.
2. A basic LangGraph graph is defined with placeholder nodes representing the agent flow.
3. A basic BAML file is created to define the function signature for check_user_intent.
4. The /api/chat endpoint is wired to be the entry point for this graph.

## Tasks / Subtasks
- [x] Install LangGraph and BAML dependencies with TypeScript typings (AC: 1)
- [x] Define initial graph structure in `backend/src/agent/graph.ts` (AC: 2)
  - [x] Stub nodes for `check_user_intent`, `offer_payment_plan`, `handle_payer`, `handle_no_debt_claim`, `handle_stonewaller`, and `generate_final_link` (AC: 2)
- [x] Create `backend/src/agent/functions.baml` with `check_user_intent` schema (AC: 3)
  - [x] Document expected enum outputs to align with LangGraph transitions (AC: 3)
- [x] Integrate graph entry point into `/api/chat` pipeline (AC: 4)
  - [x] Replace direct OpenAI call with LangGraph executor (AC: 4)
  - [x] Ensure persistence and streaming still function through the graph (AC: 4)

## Dev Notes
- Source node list from `docs/PRD.md` LangGraph Agent Flow section; align state names exactly for future implementation work.
- Keep BAML function definitions declarative and version-controlled; future stories will expand schemas for negotiation offers.
- Maintain separation between transport (`/api/chat`) and agent orchestration per `docs/architecture/coding-standards.md` for testability.
- Include TODO comments indicating which stories will flesh out placeholders to help developers follow the implementation sequence.

### Testing
- Add lightweight Jest tests ensuring the graph can instantiate and transition through placeholder nodes without throwing.
- Mock BAML outputs to exercise each path and confirm the executor returns structured responses.
- Regression-test `/api/chat` happy path to verify no regressions in streaming or persistence integrations.

## Change Log
| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-25 | 0.1     | Initial draft of story 1.4. | Codex  |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List
- **LangGraph & BAML Dependencies**: Successfully installed @langchain/langgraph v0.0.33 and @boundaryml/baml v0.208.5 with TypeScript support
- **Graph Structure**: Created comprehensive graph structure in `backend/src/agent/graph.ts` with all required nodes and state transitions
- **BAML Functions**: Defined complete BAML schema in `backend/src/agent/functions.baml` with UserIntent classification and negotiation response analysis
- **Chat Integration**: Integrated LangGraph agent into `/api/chat` pipeline with streaming compatibility and fallback support
- **Testing**: Added comprehensive Jest test suite for agent functionality with placeholder tests for Story 1.5
- **State Management**: Implemented compatible state schema for LangGraph v0.0.33 with proper TypeScript typing
- **Regression Testing**: Verified all existing tests pass (24/24) with no regressions in streaming or persistence functionality

### File List

## QA Results

