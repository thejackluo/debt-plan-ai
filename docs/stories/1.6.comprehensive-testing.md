# Story 1.6: Comprehensive Test Suite Implementation

## Status

Draft

## Story

**As a** developer,
**I want** to implement a comprehensive automated test suite with 10 detailed conversation scenarios,
**so that** I can ensure the chatbot handles all user types reliably and maintains quality over time.

## Acceptance Criteria

1. A comprehensive test suite is implemented with 10 detailed conversation scenarios covering normal and edge cases.
2. Test scenarios include: Compliant Payer, Cooperative Negotiator, Unrealistic Stonewaller, No Debt Claimant, What If Negotiator, Prompt Injection Attacker, Good Faith Promise Maker, Emotional/Venting User, Split Payment Proposer, and Bargain Hunter.
3. An automated test runner script validates conversation flows, URL generation, tone, and security measures.
4. All tests can be executed with a single command (`npm run test:scenarios`) and provide clear pass/fail reporting.
5. The test suite integrates with the existing Jest testing framework and can be run as part of CI/CD pipeline.

## Tasks / Subtasks

- [ ] Create comprehensive test data structure (AC: 1, 2)

  - [ ] Create `backend/tests/comprehensive-test-cases.json` with all 10 scenarios (AC: 2)
  - [ ] Define expected outcomes for each scenario including URL parameters, tone checks, and security validations (AC: 3)
  - [ ] Structure test data with proper categorization (normal vs edge cases) (AC: 1)

- [ ] Implement automated test runner (AC: 3, 4)

  - [ ] Create `backend/tests/run-comprehensive-scenarios.ts` with conversation simulation logic (AC: 3)
  - [ ] Implement URL parameter parsing and validation functions (AC: 3)
  - [ ] Add tone and empathy checking capabilities (AC: 3)
  - [ ] Create colored console output for clear pass/fail reporting (AC: 4)
  - [ ] Add error handling and detailed failure reporting (AC: 4)

- [ ] Integrate with package.json scripts (AC: 4, 5)

  - [ ] Add `test:scenarios` script to package.json (AC: 4)
  - [ ] Add `test:all` script that runs both Jest and scenario tests (AC: 5)
  - [ ] Ensure scripts work with CI/CD pipeline requirements (AC: 5)

- [ ] Test scenario validation (AC: 2, 3)
  - [ ] Verify all 10 test scenarios execute properly (AC: 2)
  - [ ] Validate URL generation testing for payment scenarios (AC: 3)
  - [ ] Confirm security testing catches prompt injection attempts (AC: 3)
  - [ ] Test empathy and tone validation for emotional scenarios (AC: 3)

## Dev Notes

### Test Architecture Integration

- Build upon existing Jest testing framework in `backend/tests/` directory
- Follow TypeScript patterns established in the backend codebase
- Integrate with the LangGraph agent system for conversation simulation
- Reference the testing strategy outlined in `docs/architecture/6-testing-strategy.md`

### Test Scenario Categories

**Normal Test Cases (1-5):**

1. **Compliant Payer**: Validates happy path with quick agreement
2. **Cooperative Negotiator**: Tests progression through all payment tiers
3. **Unrealistic Stonewaller**: Validates graceful exit when no agreement possible
4. **No Debt Claimant**: Tests dispute handling and referral to support
5. **What If Negotiator**: Tests payment frequency flexibility

**Edge Test Cases (6-10):** 6. **Prompt Injection Attacker**: Security testing for malicious input 7. **Good Faith Promise Maker**: Tests conversion of vague promises to concrete plans 8. **Emotional/Venting User**: Tests empathy and conversation guidance 9. **Split Payment Proposer**: Tests handling of non-standard payment structures 10. **Bargain Hunter**: Tests firmness on total debt amount constraints

### Technical Implementation Details

- **Conversation Simulation**: Each test simulates a full conversation by sending user messages sequentially and capturing agent responses
- **URL Validation**: Parse and validate `collectwise.com/payments` URLs with correct parameters (`termLength`, `totalDebtAmount`, `termPaymentAmount`)
- **Tone Analysis**: Check for empathy keywords and professional language in responses
- **Security Validation**: Ensure the agent maintains focus and doesn't break character under prompt injection attacks
- **Error Handling**: Graceful handling of agent failures with detailed error reporting

### File Structure

```
backend/tests/
├── comprehensive-test-cases.json      # Test scenario data
├── run-comprehensive-scenarios.ts     # Main test runner
└── agent.test.ts                     # Existing Jest tests (unchanged)
```

### Expected Test Output Format

```
CollectWise Comprehensive Test Suite
Running 10 conversation scenarios...

=== Normal Test Cases ===
[PASS] Case 1: The Compliant Payer
[PASS] Case 2: The Cooperative Negotiator
[FAIL] Case 3: The Unrealistic Stonewaller
  └─ Expected no URL but found payment link

=== Edge Test Cases ===
[PASS] Case 6: The Prompt Injection Attacker
...

=== Test Summary ===
Passed: 9
Failed: 1
Total: 10
Success Rate: 90%
```

### Integration Points

- **LangGraph Agent**: Tests must integrate with the `negotiationAgent.invoke()` method
- **BAML Functions**: Validate that BAML-generated responses meet test expectations
- **OpenAI API**: Tests may require mocking or using test API keys to avoid costs
- **CI/CD Pipeline**: Tests should be runnable in automated deployment pipelines

### Testing Requirements

- All tests must be deterministic and repeatable
- Tests should complete within reasonable time limits (< 2 minutes total)
- Failed tests must provide actionable debugging information
- Test suite must be maintainable and easy to extend with new scenarios

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2025-09-26 | 0.1     | Initial draft of comprehensive testing story. | BMad   |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
